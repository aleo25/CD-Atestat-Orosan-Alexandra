(()=>{"use strict";const t=async t=>new Promise(((e,s)=>{const n=new XMLHttpRequest;n.onload=()=>{e(n.responseText)},n.onerror=()=>{s(new Error("Local request failed"))},n.open("GET",t),n.send()})),e=async e=>JSON.parse(await t(e)),s=new Map,n=async(t,n)=>{const i=`${t}/assets/locales/${n}.json`;if(!s.has(i)){const t=await e(i);t&&s.set(i,t)}return s.get(i)},i=(t,e,s=0,n=0)=>new Intl.NumberFormat(t,{minimumFractionDigits:s,maximumFractionDigits:n}).format(e),r=t=>(e,s,n)=>{const r=new RegExp(`{${s},[ ]*number}`,"g");return e.replaceAll(r,i(t,+n))},o=(t,e,s)=>{const n=new RegExp(`{${e}, plural, .+?}}`,"g");let i=new RegExp("=0[ ]*{(.*?)}","g");const r=+s;1===r?i=new RegExp("one[ ]*{(.*?)}","g"):r>1&&(i=new RegExp("other[ ]*{(.*?)}","g"));const o=i.exec(t);return o?t.replaceAll(n,o[1].replace("#",s)):t},a=(t,e,s)=>t.replaceAll(`{${e}}`,s),c=(t,e,s)=>{const n=new RegExp(`{${e}, select, .+?}[ ]*}`,"g"),i=new RegExp(`${s}[ ]*{(.*?)}`,"g").exec(t);return i?t.replaceAll(n,i[1]):t},l=async(t,e,s,i,l=!1)=>{let h,d;try{if(h=await n(t,e),!h)throw new Error(`Could not find ${e} object`)}catch(e){h=await n(t,"en-GB")}return h?(d=l?h[s]:s.split(".").reduce(((t,e)=>t[e]),h),d&&((t,e,s)=>{if(!e||!s)return e;const n=[r(t),o,a,c];return Object.entries(s).reduce(((t,[e,s])=>n.reduceRight(((t,n)=>n(t,e,s)),t)),e)})(e,d,i)||s):s},h=t=>e=>{customElements.get(t.selector)||customElements.define(t.selector,e)};var d;!function(t){t.MPN="mpn",t.GTIN="gtin",t.SKU="sku"}(d||(d={}));const p=d;class T{identifiers;type;constructor(t,e,s){if(t)this.identifiers=t,this.type=p.SKU;else if(e)this.identifiers=e,this.type=p.GTIN;else{if(!s)throw new Error("No product identifier data attribute found.");this.identifiers=s,this.type=p.MPN}}getIdentifiers(){return this.identifiers}getEncodedIdentifiers(){return this.type===p.SKU?this.identifiers.map((t=>(t=>{const e=unescape(encodeURIComponent(t));let s="";for(let t=0;t<e.length;t++)s+=e.charCodeAt(t).toString(16);return s})(t))):this.identifiers}getType(){return this.type}}const E="$_PRODUCT_IDENTIFIER",u=async t=>{const s=await e(t);if("object"==typeof s&&0===Object.keys(s).length)throw new Error("Server returned empty object!");return s},g=async(t,e,s)=>{const n=t.replace("$_PRODUCT_IDENTIFIER_TYPE",e).replace(E,s);return u(n)},m=["oneStar","twoStars","threeStars","fourStars","fiveStars"];var A;!function(t){t.OS="os",t.LIGHT="light",t.DARK="dark"}(A||(A={}));const f=A;var v;!function(t){t.DEFAULT="default",t.INHERIT="inherit"}(v||(v={}));const R=v;let y=class extends HTMLElement{ATTRIBUTE_RATING="rating";MIN_GRADE=0;MAX_GRADE=5;async connectedCallback(){const t=+(this.getAttribute(this.ATTRIBUTE_RATING)??0);this.validate(t)&&this.render(t)}validate(t){return!(isNaN(t)||t<this.MIN_GRADE||t>this.MAX_GRADE)}render(t){const e=Math.floor(t),s=t%1*100,n='<div class="empty"></div>',i='<div class="filled"></div>';this.innerHTML=`\n      <div class="star-rating">\n        ${i.repeat(e)}\n        ${e!==this.MAX_GRADE?`\n              <div class="star-rating__fraction">\n                <div class="star">\n                  ${n}\n                </div>\n                <div class="star" style="width: ${s}%">\n                  ${i}\n                </div>\n              </div>\n              ${n.repeat(this.MAX_GRADE-e-1)}\n            `:""}\n      </div>\n    `}};y=function(t,e,s,n){var i,r=arguments.length,o=r<3?e:null===n?n=Object.getOwnPropertyDescriptor(e,s):n;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)o=Reflect.decorate(t,e,s,n);else for(var a=t.length-1;a>=0;a--)(i=t[a])&&(o=(r<3?i(o):r>3?i(e,s,o):i(e,s))||o);return r>3&&o&&Object.defineProperty(e,s,o),o}([h({selector:"etrusted-ps-star-rating"})],y);var w;let _=w=class extends HTMLElement{ATTRIBUTE_BASE_URL="baseUrl";ATTRIBUTE_LOCALE="locale";ATTRIBUTE_ACCENT_COLOR="data-accent-color";DEFAULT_ACCENT="#FFDC0F";baseUrl;locale;accentColor;_popoverData;rootElement;innerWidthBefore=window.innerWidth;get popoverData(){return this._popoverData}set popoverData(t){this._popoverData=t,this.render()}async connectedCallback(){this.baseUrl=this.getAttribute(this.ATTRIBUTE_BASE_URL)||"",this.locale=this.getAttribute(this.ATTRIBUTE_LOCALE)||"en-GB",this.accentColor=this.getAttribute(this.ATTRIBUTE_ACCENT_COLOR)||this.DEFAULT_ACCENT,this.attachShadow({mode:"open"}),this.addCssStyle(this.baseUrl),this.style.setProperty("--accent-color",this.accentColor),this.rootElement=this.addRootElement()}static getPercentageBar(t,e){return`\n      <div class="distribution-row">\n        <span class="rating-index">\n          ${t}\n          <span class="rating-star"><img class="star"></span>\n        </span>\n        <div class="bar">\n          <div class="bar-filled" style="width: ${e}%"></div>\n        </div>\n        <span class="percent"> ${e}% </span>\n      </div>\n    `}handleMargins=()=>{let t=0;const e=this.rootElement.querySelector(".popover"),s=this.rootElement.querySelector(".arrow");if(e&&s){const{left:n,right:i}=e.getBoundingClientRect(),r=this.innerWidthBefore,o=10;n-o<=0?t=-n+o:i+o>=r&&(t=-(i-r+o)),e.style.marginLeft=`${t}px`,s.style.marginLeft=-t+"px"}};addCssStyle(t){const e=document.createElement("style");e.setAttribute("type","text/css"),e.innerHTML=`@import "${t}/index.css"`,this.shadowRoot?.appendChild(e)}addRootElement(){const t=document.createElement("div");return t.classList.add("popover-wrapper"),this.shadowRoot?.appendChild(t),t}async render(){if(!this.popoverData)return;const{grade:t,channel:e}=this.popoverData,s=t.distribution,n=t.count,r=[s.oneStar,s.twoStars,s.threeStars,s.fourStars,s.fiveStars].map((t=>{return e=t,s=n,isNaN(e)||0===s?0:Math.round(100*e/s);var e,s})).map(((t,e)=>w.getPercentageBar(e+1,t))).reverse(),o=await l(this.baseUrl,this.locale,"totalReviewCount",{totalReviewCount:i(this.locale,n)}),a=await l(this.baseUrl,this.locale,"legalText"),c=await l(this.baseUrl,this.locale,"legalText2",{reviewLegalUrl:`${e.seoProfileUrl}#legal`});setTimeout((()=>{this.rootElement.innerHTML=`\n        <div class="popover">\n          <div class="arrow"></div>\n          <div class="header">\n            <span class="rating">\n              ${i(this.locale,t.rating,2,2)}\n            </span>\n            <span class="review-count"> ${o} </span>\n            <span class="logo">\n              <img class="logo-img">\n            </span>\n          </div>\n          <div class="body">${r.join("")}</div>\n          <div class="footer">\n            <span>${a}</span>\n            <span>${c}</span>\n          </div>\n        </div>\n      `,this.handleMargins()}),300)}};_=w=function(t,e,s,n){var i,r=arguments.length,o=r<3?e:null===n?n=Object.getOwnPropertyDescriptor(e,s):n;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)o=Reflect.decorate(t,e,s,n);else for(var a=t.length-1;a>=0;a--)(i=t[a])&&(o=(r<3?i(o):r>3?i(e,s,o):i(e,s))||o);return r>3&&o&&Object.defineProperty(e,s,o),o}([h({selector:"etrusted-ps-popover"})],_);var C;let b=C=class extends HTMLElement{CURRENT_MAJOR_VERSION="v1";QUERY_SELECTOR_PROPS='script[type="text/props"]';ATTRIBUTE_LOCALE="data-etrusted-locale";ATTRIBUTE_THEME="data-theme";ATTRIBUTE_FONT_STYLE="data-font-style";ATTRIBUTE_ACCENT_COLOR="data-accent-color";DEFAULT_ACCENT="#FFDC0F";ATTRIBUTE_SKU="data-sku";ATTRIBUTE_GTIN="data-gtin";ATTRIBUTE_MPN="data-mpn";rootElement;context;popoverElement;osThemeHost=window.matchMedia("(prefers-color-scheme: dark)");themeListener=t=>{this.setToOsStyle(t.matches)};async connectedCallback(){const t=this.getRootNode()?.host||this,e=this.getAttribute(this.ATTRIBUTE_LOCALE),s=this.getAttribute(this.ATTRIBUTE_THEME),n=this.getAttribute(this.ATTRIBUTE_FONT_STYLE),i=this.getAttribute(this.ATTRIBUTE_ACCENT_COLOR),r=this.getManifest();if(!r)return;const o=await u(r.configuration.url),a=this.getAttribute(this.ATTRIBUTE_SKU)?.split(","),c=this.getAttribute(this.ATTRIBUTE_GTIN)?.split(","),l=this.getAttribute(this.ATTRIBUTE_MPN)?.split(","),h=new T(a,c,l),d=await this.getBaseUrl(r.application.url),A=C.getDistributionUrl(r.application.url||d);this.shadowRoot||(this.attachShadow({mode:"open"}),this.addCssStyle(d),this.rootElement=this.addRootElement());const v=await u(r.feeds.channels.url),y=r.dynamicFeeds.gtin_mapping?r.dynamicFeeds.gtin_mapping.url:`${A}/feeds/mappings/gtin/v1/channels/${v.id}/${E}/mapping.json`,w=h.getType()===p.GTIN?await(async(t,e)=>{if(e.getType()!==p.GTIN)throw new Error("Product Identifier needs to be GTIN");const s=await Promise.all(e.getIdentifiers().map((e=>(async(t,e)=>{try{return await g(t,p.GTIN,e)}catch{return}})(t,e)))),n=s.filter((t=>!!t)),i=[...new Set(n.filter((t=>!!t)).map((t=>t.products.map((t=>t.sku)))).flat())];return new T(i)})(y,h):h,_=(t=>{let e=[0,0,0,0,0],s=0,n=0;t.length>0&&(e=m.map((e=>t.map((({distribution:t})=>t[e])).reduce(((t,e)=>e+t),0))),s=t.map((t=>t.count)).reduce(((t,e)=>e+t),0),n=s>0?e.reduce(((t,e,s)=>e*(s+1)+t),0)/s:0);const[i,r,o,a,c]=e;return{count:s,distribution:{fiveStars:c,fourStars:a,threeStars:o,twoStars:r,oneStar:i},rating:n}})((await(async(t,e,s)=>(await Promise.all(s.map((async s=>{try{return await g(t,e,s)}catch{return}})))).filter((t=>!!t)))(r.dynamicFeeds.grades.url,w.getType(),w.getEncodedIdentifiers())).map((t=>t.grades.overall)));this.context={baseUrl:d,manifest:r,theme:s??o.theme??f.LIGHT,fontStyle:n||o.fontStyle||R.DEFAULT,accentColor:i||o.accentColor||this.DEFAULT_ACCENT,configuration:{...o,locale:e||o.locale},channel:v,grade:_},o.hideWhenEmpty&&0===_.rating||(this.setAttribute(this.ATTRIBUTE_THEME,this.context.theme),this.setAttribute(this.ATTRIBUTE_FONT_STYLE,this.context.fontStyle),this.setAttribute(this.ATTRIBUTE_ACCENT_COLOR,this.context.accentColor),this.changeAccentColor(this.context.accentColor),await this.render(),this.setupMutationObserver(t),this.handleOSStyleListener(this.context.theme!==f.OS))}disconnectedCallback(){this.handleOSStyleListener(!0)}changeAccentColor(t){const e=t||this.DEFAULT_ACCENT;this.style.setProperty("--accent-color",e),this.context.accentColor=e}setupMutationObserver(t){const e=new MutationObserver((e=>{t!==this&&(e.forEach((e=>{const s=e.attributeName,n=t.getAttribute(s);if(s===this.ATTRIBUTE_THEME){const t=this.context.theme;this.context.theme=n??this.context.configuration.theme,this.setAttribute(this.ATTRIBUTE_THEME,n),this.handleOSStyleListener(f.OS===t||f.OS!==this.context.theme)}s===this.ATTRIBUTE_LOCALE&&(this.context.configuration.locale=n,this.setAttribute(this.ATTRIBUTE_LOCALE,n)),s===this.ATTRIBUTE_FONT_STYLE&&(this.context.fontStyle=n,this.setAttribute(this.ATTRIBUTE_FONT_STYLE,n)),s===this.ATTRIBUTE_ACCENT_COLOR&&(this.context.accentColor=n,this.setAttribute(this.ATTRIBUTE_ACCENT_COLOR,n),this.changeAccentColor(n))})),this.render())}));return e.observe(t,{attributes:!0}),e}setToOsStyle=t=>{this.setAttribute(this.ATTRIBUTE_THEME,t?"dark":"light")};handleOSStyleListener(t=!1){if(this.context.theme===f.OS||!t)return this.setToOsStyle(this.osThemeHost.matches),void this.osThemeHost.addEventListener("change",this.themeListener);this.osThemeHost.removeEventListener("change",this.themeListener)}getManifest=()=>{const t=this.querySelector(this.QUERY_SELECTOR_PROPS)?.textContent;return t?JSON.parse(t).manifest:null};showPopover=()=>{const t=this.rootElement.querySelector(".wrapper");if(t){this.popoverElement=document.createElement("etrusted-ps-popover"),this.popoverElement.onmouseleave=()=>this.hidePopover(t);const{top:e,left:s,width:n}=t.getBoundingClientRect(),{grade:i,channel:r,baseUrl:o,configuration:a,fontStyle:c,accentColor:l}=this.context,{scrollX:h,scrollY:d}=window;this.popoverElement.style.zIndex="2147483646",this.popoverElement.style.position="absolute",this.popoverElement.style.top=`${e+d}px`,this.popoverElement.style.left=`${s+h}px`,this.popoverElement.style.width=`${n}px`,this.popoverElement.setAttribute("baseUrl",o),this.popoverElement.setAttribute("locale",a.locale),this.popoverElement.setAttribute(this.ATTRIBUTE_FONT_STYLE,c),this.popoverElement.setAttribute(this.ATTRIBUTE_ACCENT_COLOR,l),this.popoverElement.setAttribute(this.ATTRIBUTE_THEME,this.getAttribute(this.ATTRIBUTE_THEME)),document.body.appendChild(this.popoverElement),this.popoverElement.popoverData={channel:r,grade:i},t.classList.add("highlighted"),setTimeout((()=>{const e=this.popoverElement.matches(":hover"),s=()=>"ontouchstart"in window||navigator.maxTouchPoints>0,n=()=>{this.hidePopover(t),document.removeEventListener("click",n),window.removeEventListener("resize",n)};e||s()||this.hidePopover(t),t.classList.contains("highlighted")&&s()&&(document.addEventListener("click",n),window.addEventListener("resize",n))}),200)}};hidePopover=t=>{this.popoverElement.remove(),t.classList.remove("highlighted")};addCssStyle(t){const e=document.createElement("style");e.setAttribute("type","text/css"),e.innerHTML=`@import "${t}/index.css"`,this.shadowRoot?.appendChild(e)}addRootElement(){const t=document.createElement("div");return t.classList.add("product-star-widget"),this.shadowRoot?.appendChild(t),t}async getBaseUrl(e){if(!e)return".";const s=await t(`${e}/LATEST_VERSION`);return e.replace(this.CURRENT_MAJOR_VERSION,s.trim())||"."}static getDistributionUrl(t){return t&&"."!==t?new URL(t).origin:t}async render(){if(!this.shadowRoot)return;const{baseUrl:t,configuration:e,theme:s}=this.context,n=this.context.grade.count,r=0===n,o=e.locale,a=r?0:this.context.grade.rating,c=r?"":`\n          <span class="grade"> ${i(o,a,2,2)} </span>\n          <span class="count"> (${i(o,n)}) </span>\n        `;if(this.rootElement.innerHTML=`\n      <div class="wrapper">\n        <etrusted-ps-star-rating\n          baseUrl="${t}"\n          rating="${a}"\n          theme="${s}"\n        ></etrusted-ps-star-rating>\n        ${c}\n      </div>\n    `,!r){const t=this.rootElement.querySelector(".wrapper");t&&(t.onmouseenter=this.showPopover)}}};b=C=function(t,e,s,n){var i,r=arguments.length,o=r<3?e:null===n?n=Object.getOwnPropertyDescriptor(e,s):n;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)o=Reflect.decorate(t,e,s,n);else for(var a=t.length-1;a>=0;a--)(i=t[a])&&(o=(r<3?i(o):r>3?i(e,s,o):i(e,s))||o);return r>3&&o&&Object.defineProperty(e,s,o),o}([h({selector:"etrusted-product-star-widget"})],b)})();