(()=>{"use strict";const t=async t=>new Promise(((e,s)=>{const i=new XMLHttpRequest;i.onload=()=>{e(i.responseText)},i.onerror=()=>{s(new Error("Local request failed"))},i.open("GET",t),i.send()})),e=async e=>JSON.parse(await t(e)),s=new Map,i=async(t,i)=>{const n=`${t}/assets/locales/${i}.json`;if(!s.has(n)){const t=await e(n);t&&s.set(n,t)}return s.get(n)},n=(t,e,s=0,i=0)=>new Intl.NumberFormat(t,{minimumFractionDigits:s,maximumFractionDigits:i}).format(e),r=t=>(e,s,i)=>{const r=new RegExp(`{${s},[ ]*number}`,"g");return e.replaceAll(r,n(t,+i))},a=(t,e,s)=>{const i=new RegExp(`{${e}, plural, .+?}}`,"g");let n=new RegExp("=0[ ]*{(.*?)}","g");const r=+s;1===r?n=new RegExp("one[ ]*{(.*?)}","g"):r>1&&(n=new RegExp("other[ ]*{(.*?)}","g"));const a=n.exec(t);return a?t.replaceAll(i,a[1].replace("#",s)):t},o=(t,e,s)=>t.replaceAll(`{${e}}`,s),l=(t,e,s)=>{const i=new RegExp(`{${e}, select, .+?}[ ]*}`,"g"),n=new RegExp(`${s}[ ]*{(.*?)}`,"g").exec(t);return n?t.replaceAll(i,n[1]):t},c=async(t,e,s,n)=>{let c;try{if(c=await i(t,e),!c)throw new Error(`Could not find ${e} object`)}catch(e){c=await i(t,"en-GB")}if(!c)return s;let d=c[s];return d||(d=s.split(".").reduce(((t,e)=>t[e]),c)),d&&((t,e,s)=>{if(!e||!s)return e;const i=[a,r(t),o,l];return Object.entries(s).reduce(((t,[e,s])=>i.reduceRight(((t,i)=>i(t,e,s)),t)),e)})(e,d,n)||s},d=t=>e=>{customElements.get(t.selector)||customElements.define(t.selector,e)};var h;!function(t){t.EXCELLENT="EXCELLENT",t.GOOD="GOOD",t.FAIR="FAIR",t.POOR="POOR",t.VERY_POOR="VERY_POOR"}(h||(h={}));const T=h;class u{count;rating;distribution;period;constructor(t){this.count=t.count,this.rating=t.rating,this.distribution=t.distribution,this.period=t.period}getGradeSummary(){return this.rating<1.5?T.VERY_POOR:this.rating<2.5?T.POOR:this.rating<3.5?T.FAIR:this.rating<4.5?T.GOOD:T.EXCELLENT}}var E;!function(t){t.DEFAULT="default",t.INHERIT="inherit"}(E||(E={}));const m=E;let g=class extends HTMLElement{ATTRIBUTE_RATING="rating";MIN_GRADE=1;MAX_GRADE=5;async connectedCallback(){const t=+(this.getAttribute(this.ATTRIBUTE_RATING)??0);this.validate(t)&&this.render(t)}validate(t){return!(isNaN(t)||t<this.MIN_GRADE||t>this.MAX_GRADE)}render(t){const e=Math.floor(t),s=t%1*100,i='<div class="empty"></div>',n='<div class="filled"></div>';this.innerHTML=`\n      <div class="star-rating">\n        ${n.repeat(e)}\n        ${e!==this.MAX_GRADE?`\n              <div class="star-rating__fraction">\n                <div class="star">\n                  ${i}\n                </div>\n                <div class="star" style="width: ${s}%">\n                  ${n}\n                </div>\n              </div>\n              ${i.repeat(this.MAX_GRADE-e-1)}\n            `:""}\n      </div>\n    `}};var R;g=function(t,e,s,i){var n,r=arguments.length,a=r<3?e:null===i?i=Object.getOwnPropertyDescriptor(e,s):i;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)a=Reflect.decorate(t,e,s,i);else for(var o=t.length-1;o>=0;o--)(n=t[o])&&(a=(r<3?n(a):r>3?n(e,s,a):n(e,s))||a);return r>3&&a&&Object.defineProperty(e,s,a),a}([d({selector:"etrusted-tss-star-rating"})],g),function(t){t.OS="os",t.LIGHT="light",t.DARK="dark"}(R||(R={}));const p=R;var f;let A=f=class extends HTMLElement{static ATTRIBUTE_IS_SHOWN="isshown";ATTRIBUTE_THEME="theme";static get observedAttributes(){return[f.ATTRIBUTE_IS_SHOWN]}isShown=!1;theme;_modalData;get modalData(){return this._modalData}set modalData(t){this._modalData=t,this.render()}connectedCallback(){document.addEventListener("click",this.handleClickOutside,!0),this.theme=this.getAttribute(this.ATTRIBUTE_THEME)||p.LIGHT}attributeChangedCallback(t,e,s){t===f.ATTRIBUTE_IS_SHOWN&&(this.isShown="true"===s),this.render()}disconnectedCallback(){document.removeEventListener("click",this.handleClickOutside,!0)}close(){this.isShown=!1,this.render()}handleMargins=()=>{let t=0,e=0;const s=this.querySelector(".modal-wrapper");if(s){const{top:i,bottom:n,left:r,right:a}=s.getBoundingClientRect(),{innerHeight:o,innerWidth:l}=window,c=10;i-c<=0?t=-i+c:n+c>=o&&(t=-(n-o+c)),r-c<=0?e=-r+c:a+c>=l&&(e=-(a-l+c)),s.style.marginTop=`${t}px`,s.style.marginLeft=`${e}px`}};handleClickOutside=t=>{const e=this.querySelector(".modal-wrapper"),s=t.composedPath()[0];e&&!e.contains(s)&&this.close()};render(){this.innerHTML="",this.isShown&&this.modalData&&(this.innerHTML=`\n      <div class="modal-wrapper">\n        <div class="modal modal--animate">\n          <div\n            id="modal-close"\n            class="modal-close"\n          ></div>\n          <div class="modal-header">\n            <div class="modal-header__stars">\n              <etrusted-tss-star-rating\n                rating="${this.modalData.rating}"\n                theme="${this.theme}"\n              ></etrusted-tss-star-rating>\n            </div>\n            <div class="modal-header__title">${this.modalData.title}</div>\n          </div>\n          <div class="modal-body">${this.modalData.body}</div>\n          <div class="modal-footer">${this.modalData.footer}</div>\n        </div>\n      </div>\n    `,this.querySelector("#modal-close").addEventListener("click",(()=>this.close())),this.handleMargins())}};A=f=function(t,e,s,i){var n,r=arguments.length,a=r<3?e:null===i?i=Object.getOwnPropertyDescriptor(e,s):i;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)a=Reflect.decorate(t,e,s,i);else for(var o=t.length-1;o>=0;o--)(n=t[o])&&(a=(r<3?n(a):r>3?n(e,s,a):n(e,s))||a);return r>3&&a&&Object.defineProperty(e,s,a),a}([d({selector:"etrusted-modal"})],A);let y=class extends HTMLElement{CURRENT_MAJOR_VERSION="v2";QUERY_SELECTOR_PROPS='script[type="text/props"]';ATTRIBUTE_WIDGET_ID="data-etrusted-widget-id";ATTRIBUTE_LOCALE="data-etrusted-locale";ATTRIBUTE_THEME="data-theme";ATTRIBUTE_FONT_STYLE="data-font-style";ATTRIBUTE_ACCENT_COLOR="data-accent-color";DEFAULT_ACCENT="#FFDC0F";rootElement;shouldShowTooltip=!1;context;osThemeHost=window.matchMedia("(prefers-color-scheme: dark)");themeListener=t=>{this.setToOsStyle(t.matches)};async connectedCallback(){const t=this.getRootNode()?.host||this,e=this.getAttribute(this.ATTRIBUTE_WIDGET_ID),s=this.getAttribute(this.ATTRIBUTE_LOCALE),i=this.getAttribute(this.ATTRIBUTE_THEME),n=this.getAttribute(this.ATTRIBUTE_FONT_STYLE),r=this.getAttribute(this.ATTRIBUTE_ACCENT_COLOR),a=this.getManifest();if(!e||!a)return;let o,l,c;try{if(o=await this.getFeed(a.feeds.channels.url),l=await this.getFeed(a.feeds.grades.url),c=await this.getFeed(a.configuration.url),0===l.grades["365days"].count)throw new Error("No grade found!")}catch(t){return}const d=await this.getBaseUrl(a.application.url);this.attachShadow({mode:"open"}),this.addCssStyle(d),this.rootElement=this.addRootElement(),this.context={baseUrl:d,manifest:a,theme:i||c.theme||p.LIGHT,fontStyle:n||c.fontStyle||m.DEFAULT,accentColor:r||c.accentColor||this.DEFAULT_ACCENT,configuration:{...c,locale:s||c.locale},feeds:{channels:o,grades:l}},this.setAttribute(this.ATTRIBUTE_THEME,this.context.theme),this.setAttribute(this.ATTRIBUTE_FONT_STYLE,this.context.fontStyle),this.setAttribute(this.ATTRIBUTE_ACCENT_COLOR,this.context.accentColor),this.changeAccentColor(this.context.accentColor),await this.render(),this.updateDisplayStyle(),this.setupMutationObserver(t),window.addEventListener("resize",this.updateDisplayStyle,!0),this.handleOSStyleListener(this.context.theme!==p.OS)}disconnectedCallback(){window.removeEventListener("resize",this.updateDisplayStyle,!0),this.handleOSStyleListener(!0)}changeAccentColor(t){const e=t||this.DEFAULT_ACCENT;this.style.setProperty("--accent-color",e),this.context.accentColor=e}setupMutationObserver(t){const e=new MutationObserver((e=>{t!==this&&(e.forEach((e=>{const s=e.attributeName,i=t.getAttribute(s);if(s===this.ATTRIBUTE_THEME){const t=this.context.theme;this.context.theme=i??this.context.configuration.theme,this.setAttribute(this.ATTRIBUTE_THEME,i),this.handleOSStyleListener(p.OS===t||p.OS!==this.context.theme)}s===this.ATTRIBUTE_LOCALE&&(this.context.configuration.locale=i,this.setAttribute(this.ATTRIBUTE_LOCALE,i)),s===this.ATTRIBUTE_FONT_STYLE&&(this.context.fontStyle=i,this.setAttribute(this.ATTRIBUTE_FONT_STYLE,i)),s===this.ATTRIBUTE_ACCENT_COLOR&&(this.context.accentColor=i,this.setAttribute(this.ATTRIBUTE_ACCENT_COLOR,i),this.changeAccentColor(i))})),this.render())}));return e.observe(t,{attributes:!0}),e}setToOsStyle=t=>{this.setAttribute(this.ATTRIBUTE_THEME,t?"dark":"light")};handleOSStyleListener(t=!1){if(this.context.theme===p.OS||!t)return this.setToOsStyle(this.osThemeHost.matches),void this.osThemeHost.addEventListener("change",this.themeListener);this.osThemeHost.removeEventListener("change",this.themeListener)}showTooltip(){this.shouldShowTooltip=!0,this.render()}updateDisplayStyle=()=>{setTimeout((()=>{const t=this.shadowRoot?.querySelector(".trusted-stars-service-widget");if(t){const e=t.offsetWidth/t.offsetHeight;e<6?(t.classList.remove("display-style-medium"),t.classList.add("display-style-small")):e<7.7?(t.classList.remove("display-style-small"),t.classList.add("display-style-medium")):t.classList.remove("display-style-small","display-style-medium")}}))};getFeed=async t=>{const s=await e(t);if("object"==typeof s&&0===Object.keys(s).length)throw new Error("Server returned empty object!");return s};getManifest=()=>{const t=this.querySelector(this.QUERY_SELECTOR_PROPS)?.textContent;return t?JSON.parse(t).manifest:null};addCssStyle(t){const e=document.createElement("style");e.setAttribute("type","text/css"),e.innerHTML=`@import "${t}/index.css"`,this.shadowRoot?.appendChild(e)}addRootElement(){const t=document.createElement("div");return t.classList.add("trusted-stars-service-widget"),this.shadowRoot?.appendChild(t),t}async getBaseUrl(e){if(!e)return".";const s=await t(`${e}/LATEST_VERSION`);return e.replace(this.CURRENT_MAJOR_VERSION,s.trim())||"."}async render(){if(!this.shadowRoot)return;const{baseUrl:t,feeds:e,configuration:s,theme:i}=this.context,{channels:r,grades:a}=e;if(!r||!a)return;const o=s.locale,l=new u(e.grades.grades["365days"]),d=n(o,l.rating,2,2),h=n(o,l.count),T=n(o,e.grades.grades.overall.count);this.rootElement.innerHTML=`\n      <div class="wrapper">\n        <div class="content">\n          <etrusted-tss-star-rating\n            rating="${l.rating}"\n            theme="${i}"\n          >\n          </etrusted-tss-star-rating>\n          <div class="grade-value">\n            ${n(o,l.rating,2,2)}\n          </div>\n          <div class="grade-summary">\n            ${await c(t,o,"gradeSummary",{gradeSummary:l.getGradeSummary()})}\n          </div>\n          <div class="grade-count">\n            ${await c(t,o,"totalReviewCount.copy",{totalReviewCount:T})}\n          </div>\n          <div class="logo"></div>\n        </div>\n      </div>\n      <etrusted-modal isshown="${this.shouldShowTooltip}" theme="${i}"></etrusted-modal>\n    `,this.rootElement.querySelector(".content").addEventListener("click",(()=>this.showTooltip()));const E=this.rootElement.querySelector("etrusted-modal");E&&(E.modalData={baseUrl:t,rating:l.rating,title:await c(t,o,"gradeTooltip.header",{grade:d,maxGrade:"5"}),body:await c(t,o,"gradeTooltip.body",{seoProfileUrl:r.seoProfileUrl,yearReviewCount:h,totalReviewCount:T}),footer:await c(t,o,"gradeTooltip.footer",{seoProfileLegalUrl:`${r.seoProfileUrl}#legal`})})}};y=function(t,e,s,i){var n,r=arguments.length,a=r<3?e:null===i?i=Object.getOwnPropertyDescriptor(e,s):i;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)a=Reflect.decorate(t,e,s,i);else for(var o=t.length-1;o>=0;o--)(n=t[o])&&(a=(r<3?n(a):r>3?n(e,s,a):n(e,s))||a);return r>3&&a&&Object.defineProperty(e,s,a),a}([d({selector:"etrusted-trusted-stars-service-widget"})],y)})();